<!DOCTYPE html>

<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Codenames Game</title>
  <link rel="shortcut icon" type="image/x-icon" href="images/favicon.ico">
  <link rel="stylesheet" href="stylesheets/page.css">
</head>

<body>

  <div id="roleChangeSection">
    <button id="changeRoleButton" onclick="changeRole()">Change Role</button>
  </div>

  <section id="mainGame">
    <div id="clueInput">
      <input type="text" id="clueInputField" name="clueInput" placeholder="hint" readonly>
      <input type="number" id="clueInputNumber" name="clueNumber" placeholder="num" min="1" max="9" readonly>
      <button id="submitClueButton" onclick="submitClue()" hidden>Submit Clue</button>
    </div>
    <div id="board"></div>
    <button id="passButton" onclick="passTurn()">Pass Turn</button>
  </section>

  <div id="sidebar" class="sidebar">
    <button id="sidebarButton" onclick="sidebar()">&times;</button>
    <div id="sidebarContent" class="sidebarContent">
      <div class="counters">
        <div id="blueLeft"></div> <div id="redLeft"></div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let isSpymaster = false;
    socket.emit("update")

    socket.on("update", (gameState) => {
      updateCardsCount(gameState.blueCards, gameState.redCards);
      showClueInput(gameState)
      changeTurn(gameState.isBlueTurn);
      renderBoard(gameState.gameBoard, gameState.moveCounter);
    });

    function changeRole() {
      isSpymaster = !isSpymaster;
      socket.emit("update")
    }

    function passTurn() {
      socket.emit("turnPassed");
    }

    function submitClue(){
      newClue = document.getElementById("clueInputField").value;
      clueNumber = document.getElementById("clueInputNumber").value;
      socket.emit("clueSubmit", newClue, clueNumber );
    }

    function showClueInput(gameState) {
      const input = document.getElementById("clueInput");
      const clueInputField = document.getElementById("clueInputField");
      const clueInputNumber = document.getElementById("clueInputNumber");
      const submitClueButton = document.getElementById("submitClueButton");
      const changeButton = document.getElementById("passButton");

      clueInputField.value = gameState.currentClue;
      clueInputNumber.value = gameState.moveCounter;
      if (isSpymaster) {
        clueInputField.removeAttribute("readonly");
        clueInputNumber.removeAttribute("readonly");
        submitClueButton.removeAttribute("hidden");
        changeButton.setAttribute("hidden", true);
      } else {
        clueInputField.setAttribute("readonly", true);
        clueInputNumber.setAttribute("readonly", true);
        submitClueButton.setAttribute("hidden", true);
        changeButton.removeAttribute("hidden");
      }
    }

    function updateCardsCount(blueCount, redCount) {
      document.getElementById("blueLeft").textContent = blueCount;
      document.getElementById("redLeft").textContent = redCount;
    }

    function changeTurn(isBlueTurn) {
      if (isBlueTurn) {
        document.body.classList.add("blueTurn");
        document.body.classList.remove("redTurn");
      } else {
        document.body.classList.add("redTurn");
        document.body.classList.remove("blueTurn");
      }
    }

    function renderBoard(gameBoard, moveCounter) {
      const board = document.getElementById('board');
      board.innerHTML = '';
      for (let i = 0; i < 25; i++) {
        let gameCard = gameBoard[i];
        const card = document.createElement("div");
        card.className = "card";
        card.textContent = gameCard.word;

        if (gameCard.revealed || isSpymaster) {
          card.classList.add(gameCard.color);
        };
        if (gameCard.revealed && isSpymaster) {
          card.classList.add("revealed");
        };

        card.addEventListener("click", (event) => {
          event.preventDefault();
          if (!gameCard.revealed) {
            card.classList.toggle("highlight");
          }
        });
        if (!isSpymaster && !gameCard.revealed && moveCounter != null) {
          card.addEventListener("dblclick", (event) => {
            event.preventDefault();
            socket.emit("revealCard", i);
          });
        }

        board.appendChild(card);
      }
    }

    function sidebar() {
      document.getElementById("sidebar").classList.toggle("expanded");
      document.getElementById("sidebarContent").classList.toggle("expanded");
    }

  </script>

</body>

</html>
